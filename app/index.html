<!DOCTYPE html>
<html lang="en">

<style>
    .hidden {
        display: hidden;
    }
</style>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dollar Cost Averaging</title>
    <script src="https://cdn.plot.ly/plotly-1.8.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
</head>

<div class="container">
    <h1 class='my-3'>Dollar cost averaging</h1>

    <div class="row">
        <div class="col-md-6">
            <h6>Start Date </h6>
            <input type="date" id="start" class="form-control" name="trip-start" value="2016-07-22" min="200-01-01"
                max="2018-12-31">
        </div>
        <div class="col-md-6">
            <h6>End Date </h6>
            <input type="date" id="end" class="form-control" name="trip-start" value="2018-07-22">
        </div>
    </div>

    <br>
    <div class="row my-3">
        <div class="col-md-6">
            <h6>Monthly amount invested</h6>
            <div class="input-group">
                <span class="input-group-text">$</span>
                <input id="monthlyAmount" type="text" class="form-control" aria-label="Amount (to the nearest dollar)"
                    value="100" placeholder='Monthly amount invested'>

            </div>
        </div>
        <div class="col-md-6">
            <h6>Ticker </h6>
            <input id="ticker" type="text" class="form-control" aria-label="Ticker Symbol" value="VOO">
        </div>
    </div>


    <button type="button" id='recalc' class="btn btn-primary my-3">Calculate dollar cost average</button>

    <div id="error" class="alert alert-warning alert-dismissible fade show" hidden role="alert">
        <strong>Whoops!</strong> Please recheck your input.
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <body>
        <div id="graph"></div>
    </body>

</div>

<!-- TODO: now you would have x dollar -->
<!-- TICKER -->

<script src="./env.js"></script>
<script>
    const graphDiv = document.getElementById('graph');
    const recalcBtn = document.getElementById('recalc');
    const errorElem = document.getElementById('error');

    const userInputElements = {
        start: document.getElementById('start'),
        end: document.getElementById('end'),
        monthlyAmount: document.getElementById('monthlyAmount'),
        ticker: document.getElementById('ticker')
    }

    const userOptions = parseUserInput(userInputElements)

    const selectorOptions = {
        buttons: [{
            step: 'month',
            stepmode: 'backward',
            count: 1,
            label: '1m'
        }, {
            step: 'month',
            stepmode: 'backward',
            count: 6,
            label: '6m'
        }, {
            step: 'year',
            stepmode: 'todate',
            count: 1,
            label: 'YTD'
        }, {
            step: 'year',
            stepmode: 'backward',
            count: 1,
            label: '1y'
        }, {
            step: 'all',
        }],
    };

    mkPlot(userOptions)

    recalcBtn.addEventListener('click', () => {
        const userOptions = parseUserInput(userInputElements)
        mkPlot(userOptions)
    })


    function parseUserInput(userInputElements) {
        return {
            start: new Date(userInputElements.start.value),
            end: new Date(userInputElements.end.value),
            monthlyAmount: parseFloat(userInputElements.monthlyAmount.value),
            ticker: userInputElements.ticker.value.toUpperCase()
        }
    }

    function getURL(userOptions) {
        return `https://www.alphavantage.co/query?function=TIME_SERIES_MONTHLY&symbol=${userOptions.ticker}&apikey=${API_KEY}&datatype=csv`;
    }

    function requestIsValid(rawData) {
        return rawData.length > 0 && rawData[0]['{'] === undefined
    }

    function mkPlot(userOptions) {
        const url = getURL(userOptions)
        Plotly.d3.csv(url, (err, rawData) => {
            if (err) throw err;
            if (!requestIsValid(rawData)){
                console.log('yo')
                errorElem.hidden = false
                return
            }

            errorElem.hidden = true
            const allData = parseRawData(rawData);
            const filteredData = filterData(allData, userOptions.start, userOptions.end)
            const dca = calcDCA(filteredData, userOptions.monthlyAmount)
            const pltData = formatDataForPlot(filteredData)
            const layout = setLayout(filteredData, dca, userOptions)

            Plotly.newPlot(graphDiv, pltData, layout, { showSendToCloud: true });
        })
    }

    function setLayout(filteredData, dca, userOptions) {
        return layout = {
            title: 'Dollar cost averaging',
            xaxis: {
                rangeselector: selectorOptions,
                rangeslider: {}
            },
            yaxis: {
                fixedrange: true
            },
            shapes: [{
                type: 'line',
                x0: userOptions.start.valueOf(),
                y0: dca.avgBuyPrice,
                x1: userOptions.end.valueOf(),
                y1: dca.avgBuyPrice,
                line: {
                    color: 'rgb(50, 171, 96)',
                    width: 1,
                    dash: 'dashdot'
                }
            }]
        };

    }

    function formatDataForPlot(data) {
        var x = [];
        var y = [];

        data.forEach(function (tick) {
            x.push(tick.timestamp);
            y.push(tick.close);
        });

        return [{
            mode: 'lines',
            x: x,
            y: y
        }];
    }

    function filterData(data, start, end) {
        return data.filter(tick => {
            const ts = tick.timestamp.valueOf()
            return start < ts && ts < end
        })
    }


    function calcDCA(data, amount = monthlyAmount) {
        const totalInvested = data.length * amount
        const numStocks = data.map(tick => amount / tick.close).reduce((a, b) => a + b)
        const avgBuyPrice = totalInvested / numStocks

        return {
            totalInvested: totalInvested,
            numStocks: numStocks,
            avgBuyPrice: avgBuyPrice
        }
    }

    function parseRawData(data) {
        data.forEach((tick, idx) => data[idx].timestamp = new Date(tick.timestamp))
        return data
    }


</script>

</html>