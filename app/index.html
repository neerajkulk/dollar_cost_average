<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dollar Cost Averaging</title>
    <script src="https://cdn.plot.ly/plotly-1.8.0.min.js"></script>
</head>

<body>
    <div id="graph"></div>
</body>

<!-- TODO: now you would have x dollar -->

<script src="./env.js"></script>
<script>
    const monthlyAmount = 100
    var graphDiv = document.getElementById('graph');

    var rawDataURL = `https://www.alphavantage.co/query?function=TIME_SERIES_MONTHLY&symbol=TSLA&apikey=${API_KEY}&datatype=csv`;

    var selectorOptions = {
        buttons: [{
            step: 'month',
            stepmode: 'backward',
            count: 1,
            label: '1m'
        }, {
            step: 'month',
            stepmode: 'backward',
            count: 6,
            label: '6m'
        }, {
            step: 'year',
            stepmode: 'todate',
            count: 1,
            label: 'YTD'
        }, {
            step: 'year',
            stepmode: 'backward',
            count: 1,
            label: '1y'
        }, {
            step: 'all',
        }],
    };

    Plotly.d3.csv(rawDataURL, function (err, rawData) {
        if (err) throw err;

        const allData = parseRawData(rawData);
        const { pltData, layout } = mkPlotData(allData, 0, Infinity)
        
        Plotly.plot(graphDiv, pltData, layout, { showSendToCloud: true });

        graphDiv.on('plotly_relayout',
            function (eventdata) {
                const start = eventdata['xaxis.range[0]']
                const end = eventdata['xaxis.range[1]']
        
                if (start === undefined || end === undefined) return
        
                const { pltData, layout } = mkPlotData(allData, start, end)
                Plotly.newPlot(graphDiv, pltData, layout, { showSendToCloud: true });

            });
    });

    function mkPlotData(allData, start, end) {
        const filteredData = filterData(allData, start, end)
        const dca = calcDCA(filteredData, monthlyAmount)
        return {
            pltData: formatDataForPlot(filteredData),
            layout: setLayout(filteredData, dca)
        }
    }

    function getRange(data) {
        return {
            start: data[0].timestamp.valueOf(),
            end: data[data.length - 1].timestamp.valueOf()
        }
    }

    function setLayout(filteredData, dca) {
        const { start, end } = getRange(filteredData)
        return layout = {
            title: 'Dollar cost averaging',
            xaxis: {
                rangeselector: selectorOptions,
                rangeslider: {}
            },
            yaxis: {
                fixedrange: true
            },
            shapes: [{
                type: 'line',
                x0: start,
                y0: dca.avgBuyPrice,
                x1: end,
                y1: dca.avgBuyPrice,
                line: {
                    color: 'rgb(50, 171, 96)',
                    width: 1,
                    dash: 'dashdot'
                }
            }]
        };

    }


    function formatDataForPlot(data) {
        var x = [];
        var y = [];

        data.forEach(function (tick) {
            x.push(tick.timestamp);
            y.push(tick.close);
        });

        return [{
            mode: 'lines',
            x: x,
            y: y
        }];
    }

    function filterData(data, start, end) {
        return data.filter(tick => {
            const ts = tick.timestamp.valueOf()
            return start < ts && ts < end
        })
    }


    function calcDCA(data, amount = monthlyAmount) {
        const totalInvested = data.length * amount
        const numStocks = data.map(tick => amount / tick.close).reduce((a, b) => a + b)
        const avgBuyPrice = totalInvested / numStocks

        return {
            totalInvested: totalInvested,
            numStocks: numStocks,
            avgBuyPrice: avgBuyPrice
        }
    }

    function parseRawData(data) {
        data.forEach((tick, idx) => data[idx].timestamp = new Date(tick.timestamp))
        return data
    }


</script>

</html>